# Avito Shop – Магазин мерча

## Описание проекта

Внутренний магазин мерча для сотрудников компании Avito, в котором каждому новому сотруднику автоматически выдаётся 1000 монет (coin). Эти монеты можно использовать для покупки мерча или обмена с другими сотрудниками. Приложение позволяет:

- **Аутентификация и авторизация:**  
  Пользователь проходит регистрацию/вход с использованием email(только email, test@example.ru, при обычном имени пройти эти этапы не получится) и пароля (пароль должен содержать не менее 8 символов). При первой аутентификации пользователь создаётся автоматически. Для доступа к API используется JWT-токен, который выдается после успешной аутентификации.

- **Покупка мерча:**  
  Сотрудник может приобрести товары за монеты. При покупке происходит проверка баланса, списывание средств и создание заказа с использованием транзакций.

- **Обмен монетами:**  
  Сотрудники могут переводить монеты друг другу. При переводе обновляются балансы обоих пользователей и регистрируется транзакция. Баланс никогда не может стать отрицательным.

- **Просмотр информации:**  
  Пользователь может получить информацию о своем балансе, списке купленных товаров (мерч) и истории транзакций (отправленные и полученные монеты), включая отправителей/получателей.  

## Технический стек

- **Язык:** Go 1.23
- **База данных:** PostgreSQL (используется PostgreSQL 13, хост: `db` в Docker-сети, порт: 5432)
- **Авторизация:** JWT (секрет передается через переменные окружения)
- **Валидация:** [go-playground/validator](https://github.com/go-playground/validator) (требования: email должен быть валидным, пароль – не менее 8 символов)
- **Нагрузочное тестирование:** k6 (результаты тестов находятся в директории `tests/load-tests`)
- **Тестирование:** Unit-тесты и интеграционные/E2E-тесты (покрытие бизнес-сценариев >50%)
- **Линтер:** Настройка в файле `.golangci.yaml`
- **Деплой:** Docker Compose

## Архитектура проекта

- **`cmd/`**
    - `server/main.go` – точка входа для запуска сервера.
    - `migrator/main.go` – запускает миграции базы данных.
- **`internal/app/handlers/`** – HTTP-обработчики (например, `auth.go`, `info.go`, `buy.go`, `sendcoin.go`).
- **`internal/service/`** – бизнес-логика (сервисы аутентификации, покупки, перевода монет, получения информации).
- **`internal/storage/`** – репозитории для работы с базой данных (пользователи, мерч, заказы, транзакции).
- **`internal/config/`** – загрузка конфигурации (используется cleanenv).
- **`internal/jwt-new/`** – JWT-генерация и middleware для проверки авторизации.
- **`tests/`** – интеграционные и Е2Е тесты проекта, включая нагрузочные (load tests).

## Запуск приложения

### Через Docker Compose

1. **Настройка переменных окружения:**  
   Скопируйте файл `.env.example` и создайте `.env` (если требуется) с содержимым, например:
   ```env
   POSTGRES_PASSWORD=postgres123
   JWT_SECRET=secret123

2. **Запуск контейнеров:**
   ```sh
   docker-compose up --build
   ```
    - `db` – PostgreSQL.
    - `migrator` – запускаает миграции
    - `server` – запускает API (http://localhost:8080)

## Тестирование

### Unit-тесты
```sh
go test -cover ./...
go test -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
```

### Интеграционные и E2E-тесты
```sh
go test -v ./tests/...
```

### Линтер
```sh
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
golangci-lint run ./...
```

## Нагрузочное тестирование

Используется `k6`.  
    Вставьте в поле `<your_jwt_valid>` текущий валидный jwt токен и запустите тест
```sh
k6 run load_test.js 
```

Результаты и метрики сохранились в `tests/load-tests`.  

- RPS — 1k
- SLI времени ответа <35 мс
- SLI успешности ответа — 100%

## Логирование (меняется в local.yaml)

- **local:** цветной (кастомный) вывод
- **dev/prod:** JSON-логи для мониторинга 

## Безопасность

- Использование переменных окружения для секретов.
- Валидация email и пароля.
- JWT-токены для защиты API.

## Миграции 

- Чтобы сохранить историю заказов и избежать потери информации о товарах, которые уже были куплены, я реализовал **soft deletion** для таблицы `merch`. Вместо того чтобы полностью удалять запись о товаре из базы данных при необходимости её удаления, мы добавляем булевое поле `is_active` (default TRUE)


## Заключение

**Проект Avito Shop** предназначен для внутреннего использования и поддерживает до **100k сотрудников** при **1k RPS**.

### Реализованы:
- Аутентификация и авторизация.
- Покупка товаров.
- Перевод монет.
- Просмотр истории транзакций и инвентаря.
- Покрытие бизнес сценариев юнит-тестами. Общее тестовое покрытие > 40%.
- E2E-тесты на сценарии покупки мерча и передачи монеток другим сотрудникам

### Дополнительно реализованы:
- Нагрузочное тестирование при помощи к6 (результаты прикреплены).
- Интеграционные и E2E-тесты для разных сценариев.
- Линтер (`golangci-lint`).


